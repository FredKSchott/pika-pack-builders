{"version":3,"file":"index.js","sources":["../dist-src/index.js"],"sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport babelPluginDynamicImportSyntax from '@babel/plugin-syntax-dynamic-import';\nimport babelPluginImportMetaSyntax from '@babel/plugin-syntax-import-meta';\nimport babelPresetEnv from '@babel/preset-env';\nimport babelPluginDynamicImport from 'babel-plugin-dynamic-import-node-babel-7';\nimport builtinModules from 'builtin-modules';\nimport rollupBabel from 'rollup-plugin-babel';\nimport { MessageError } from '@pika/types';\nimport { rollup } from 'rollup';\nconst DEFAULT_ENTRYPOINT = 'main';\nconst DEFAULT_MIN_NODE_VERSION = '8';\nexport function manifest(manifest, { options }) {\n    let keys = options.entrypoint || [DEFAULT_ENTRYPOINT];\n    if (typeof keys === 'string') {\n        keys = [keys];\n    }\n    for (const key of keys) {\n        manifest[key] = manifest[key] || 'dist-node/index.js';\n    }\n}\nexport async function beforeJob({ out }) {\n    const srcDirectory = path.join(out, 'dist-src/');\n    if (!fs.existsSync(srcDirectory)) {\n        throw new MessageError('\"dist-src/\" does not exist, or was not yet created in the pipeline.');\n    }\n    const srcEntrypoint = path.join(out, 'dist-src/index.js');\n    if (!fs.existsSync(srcEntrypoint)) {\n        throw new MessageError('\"dist-src/index.js\" is the expected standard entrypoint, but it does not exist.');\n    }\n}\nexport async function build({ out, reporter, options }) {\n    const writeToNode = path.join(out, 'dist-node', 'index.js');\n    // TODO: KEEP FIXING THIS,\n    const result = await rollup({\n        input: path.join(out, 'dist-src/index.js'),\n        external: builtinModules,\n        plugins: [\n            rollupBabel({\n                babelrc: false,\n                compact: false,\n                presets: [\n                    [\n                        babelPresetEnv,\n                        {\n                            modules: false,\n                            targets: { node: options.minNodeVersion || DEFAULT_MIN_NODE_VERSION },\n                            spec: true,\n                        },\n                    ],\n                ],\n                plugins: [babelPluginDynamicImport, babelPluginDynamicImportSyntax, babelPluginImportMetaSyntax],\n            }),\n        ],\n        onwarn: ((warning, defaultOnWarnHandler) => {\n            // Unresolved external imports are expected\n            if (warning.code === 'UNRESOLVED_IMPORT' &&\n                !(warning.source.startsWith('./') || warning.source.startsWith('../'))) {\n                return;\n            }\n            defaultOnWarnHandler(warning);\n        }),\n    });\n    await result.write({\n        file: writeToNode,\n        format: 'cjs',\n        exports: 'named',\n        sourcemap: options.sourcemap === undefined ? true : options.sourcemap,\n    });\n    reporter.created(writeToNode, 'main');\n}\n"],"names":["DEFAULT_ENTRYPOINT","DEFAULT_MIN_NODE_VERSION","manifest","options","keys","entrypoint","key","beforeJob","out","srcDirectory","path","join","fs","existsSync","MessageError","srcEntrypoint","build","reporter","writeToNode","result","rollup","input","external","builtinModules","plugins","rollupBabel","babelrc","compact","presets","babelPresetEnv","modules","targets","node","minNodeVersion","spec","babelPluginDynamicImport","babelPluginDynamicImportSyntax","babelPluginImportMetaSyntax","onwarn","warning","defaultOnWarnHandler","code","source","startsWith","write","file","format","exports","sourcemap","undefined","created"],"mappings":";;;;;;;;;;;;;;;;;AAUA,MAAMA,kBAAkB,GAAG,MAA3B;AACA,MAAMC,wBAAwB,GAAG,GAAjC;AACA,AAAO,SAASC,QAAT,CAAkBA,QAAlB,EAA4B;EAAEC;CAA9B,EAAyC;MACxCC,IAAI,GAAGD,OAAO,CAACE,UAAR,IAAsB,CAACL,kBAAD,CAAjC;;MACI,OAAOI,IAAP,KAAgB,QAApB,EAA8B;IAC1BA,IAAI,GAAG,CAACA,IAAD,CAAP;;;OAEC,MAAME,GAAX,IAAkBF,IAAlB,EAAwB;IACpBF,QAAQ,CAACI,GAAD,CAAR,GAAgBJ,QAAQ,CAACI,GAAD,CAAR,IAAiB,oBAAjC;;;AAGR,AAAO,eAAeC,SAAf,CAAyB;EAAEC;CAA3B,EAAkC;QAC/BC,YAAY,GAAGC,IAAI,CAACC,IAAL,CAAUH,GAAV,EAAe,WAAf,CAArB;;MACI,CAACI,EAAE,CAACC,UAAH,CAAcJ,YAAd,CAAL,EAAkC;UACxB,IAAIK,kBAAJ,CAAiB,qEAAjB,CAAN;;;QAEEC,aAAa,GAAGL,IAAI,CAACC,IAAL,CAAUH,GAAV,EAAe,mBAAf,CAAtB;;MACI,CAACI,EAAE,CAACC,UAAH,CAAcE,aAAd,CAAL,EAAmC;UACzB,IAAID,kBAAJ,CAAiB,iFAAjB,CAAN;;;AAGR,AAAO,eAAeE,KAAf,CAAqB;EAAER,GAAF;EAAOS,QAAP;EAAiBd;CAAtC,EAAiD;QAC9Ce,WAAW,GAAGR,IAAI,CAACC,IAAL,CAAUH,GAAV,EAAe,WAAf,EAA4B,UAA5B,CAApB,CADoD;;QAG9CW,MAAM,GAAG,MAAMC,aAAM,CAAC;IACxBC,KAAK,EAAEX,IAAI,CAACC,IAAL,CAAUH,GAAV,EAAe,mBAAf,CADiB;IAExBc,QAAQ,EAAEC,cAFc;IAGxBC,OAAO,EAAE,CACLC,WAAW,CAAC;MACRC,OAAO,EAAE,KADD;MAERC,OAAO,EAAE,KAFD;MAGRC,OAAO,EAAE,CACL,CACIC,cADJ,EAEI;QACIC,OAAO,EAAE,KADb;QAEIC,OAAO,EAAE;UAAEC,IAAI,EAAE7B,OAAO,CAAC8B,cAAR,IAA0BhC;SAF/C;QAGIiC,IAAI,EAAE;OALd,CADK,CAHD;MAaRV,OAAO,EAAE,CAACW,wBAAD,EAA2BC,8BAA3B,EAA2DC,2BAA3D;KAbF,CADN,CAHe;IAoBxBC,MAAM,EAAG,CAACC,OAAD,EAAUC,oBAAV,KAAmC;;UAEpCD,OAAO,CAACE,IAAR,KAAiB,mBAAjB,IACA,EAAEF,OAAO,CAACG,MAAR,CAAeC,UAAf,CAA0B,IAA1B,KAAmCJ,OAAO,CAACG,MAAR,CAAeC,UAAf,CAA0B,KAA1B,CAArC,CADJ,EAC4E;;;;MAG5EH,oBAAoB,CAACD,OAAD,CAApB;;GA1BmB,CAA3B;QA6BMpB,MAAM,CAACyB,KAAP,CAAa;IACfC,IAAI,EAAE3B,WADS;IAEf4B,MAAM,EAAE,KAFO;IAGfC,OAAO,EAAE,OAHM;IAIfC,SAAS,EAAE7C,OAAO,CAAC6C,SAAR,KAAsBC,SAAtB,GAAkC,IAAlC,GAAyC9C,OAAO,CAAC6C;GAJ1D,CAAN;EAMA/B,QAAQ,CAACiC,OAAT,CAAiBhC,WAAjB,EAA8B,MAA9B;;;;;;;"}