{"version":3,"file":"index.js","sources":["../dist-src/index.js"],"sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport babelPluginDynamicImportSyntax from '@babel/plugin-syntax-dynamic-import';\nimport babelPluginImportMetaSyntax from '@babel/plugin-syntax-import-meta';\nimport babelPresetEnv from '@babel/preset-env';\nimport babelPluginDynamicImport from 'babel-plugin-dynamic-import-node-babel-7';\nimport builtinModules from 'builtin-modules';\nimport rollupBabel from 'rollup-plugin-babel';\nimport { MessageError } from '@pika/types';\nimport { rollup } from 'rollup';\nconst DEFAULT_ENTRYPOINT = 'main';\nconst DEFAULT_MIN_NODE_VERSION = '8';\nexport function manifest(manifest, { options }) {\n    if (options.entrypoint !== null) {\n        let keys = options.entrypoint || [DEFAULT_ENTRYPOINT];\n        if (typeof keys === 'string') {\n            keys = [keys];\n        }\n        for (const key of keys) {\n            manifest[key] = manifest[key] || 'dist-node/index.js';\n        }\n    }\n}\nexport async function beforeJob({ out }) {\n    const srcDirectory = path.join(out, 'dist-src/');\n    if (!fs.existsSync(srcDirectory)) {\n        throw new MessageError('\"dist-src/\" does not exist, or was not yet created in the pipeline.');\n    }\n    const srcEntrypoint = path.join(out, 'dist-src/index.js');\n    if (!fs.existsSync(srcEntrypoint)) {\n        throw new MessageError('\"dist-src/index.js\" is the expected standard entrypoint, but it does not exist.');\n    }\n}\nexport async function build({ out, reporter, options }) {\n    const writeToNode = path.join(out, 'dist-node', 'index.js');\n    // TODO: KEEP FIXING THIS,\n    const result = await rollup({\n        input: path.join(out, 'dist-src/index.js'),\n        external: builtinModules,\n        plugins: [\n            rollupBabel({\n                babelrc: false,\n                compact: false,\n                presets: [\n                    [\n                        babelPresetEnv,\n                        {\n                            modules: false,\n                            targets: { node: options.minNodeVersion || DEFAULT_MIN_NODE_VERSION },\n                            spec: true,\n                        },\n                    ],\n                ],\n                plugins: [babelPluginDynamicImport, babelPluginDynamicImportSyntax, babelPluginImportMetaSyntax],\n            }),\n        ],\n        onwarn: ((warning, defaultOnWarnHandler) => {\n            // Unresolved external imports are expected\n            if (warning.code === 'UNRESOLVED_IMPORT' &&\n                !(warning.source.startsWith('./') || warning.source.startsWith('../'))) {\n                return;\n            }\n            defaultOnWarnHandler(warning);\n        }),\n    });\n    await result.write({\n        file: writeToNode,\n        format: 'cjs',\n        exports: 'named',\n        sourcemap: options.sourcemap === undefined ? true : options.sourcemap,\n    });\n    reporter.created(writeToNode, 'main');\n}\n"],"names":["DEFAULT_ENTRYPOINT","DEFAULT_MIN_NODE_VERSION","manifest","options","entrypoint","keys","key","beforeJob","out","srcDirectory","path","join","fs","existsSync","MessageError","srcEntrypoint","build","reporter","writeToNode","result","rollup","input","external","builtinModules","plugins","rollupBabel","babelrc","compact","presets","babelPresetEnv","modules","targets","node","minNodeVersion","spec","babelPluginDynamicImport","babelPluginDynamicImportSyntax","babelPluginImportMetaSyntax","onwarn","warning","defaultOnWarnHandler","code","source","startsWith","write","file","format","exports","sourcemap","undefined","created"],"mappings":"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"}