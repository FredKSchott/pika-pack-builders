{"version":3,"file":"index.js","sources":["../dist-src/index.js"],"sourcesContent":["import path from 'path';\nimport fs from 'fs';\nimport execa from 'execa';\nimport { MessageError } from '@pika/types';\nimport { Lint } from 'standard-pkg';\nimport * as tsc from 'typescript';\nfunction formatTscParserErrors(errors) {\n    return errors.map(s => JSON.stringify(s, null, 4)).join('\\n');\n}\nfunction readCompilerOptions(configPath) {\n    // First step: Let tsc pick up the config.\n    const loaded = tsc.readConfigFile(configPath, file => {\n        const read = tsc.sys.readFile(file);\n        // See https://github.com/Microsoft/TypeScript/blob/a757e8428410c2196886776785c16f8f0c2a62d9/src/compiler/sys.ts#L203 :\n        // `readFile` returns `undefined` in case the file does not exist!\n        if (!read) {\n            throw new Error(`ENOENT: no such file or directory, open '${configPath}'`);\n        }\n        return read;\n    });\n    // In case of an error, we cannot go further - the config is malformed.\n    if (loaded.error) {\n        throw new Error(JSON.stringify(loaded.error, null, 4));\n    }\n    // Second step: Parse the config, resolving all potential references.\n    const basePath = path.dirname(configPath); // equal to \"getDirectoryPath\" from ts, at least in our case.\n    const parsedConfig = tsc.parseJsonConfigFileContent(loaded.config, tsc.sys, basePath);\n    // In case the config is present, it already contains possibly merged entries from following the\n    // 'extends' entry, thus it is not required to follow it manually.\n    // This procedure does NOT throw, but generates a list of errors that can/should be evaluated.\n    if (parsedConfig.errors.length > 0) {\n        const formattedErrors = formatTscParserErrors(parsedConfig.errors);\n        throw new Error(`Some errors occurred while attempting to read from ${configPath}: ${formattedErrors}`);\n    }\n    return parsedConfig.options;\n}\nfunction getTsConfigPath(options, cwd) {\n    return path.resolve(cwd, options.tsconfig || 'tsconfig.json');\n}\nexport async function beforeBuild({ cwd, options, reporter }) {\n    const tscBin = path.join(cwd, 'node_modules/.bin/tsc');\n    if (!fs.existsSync(tscBin)) {\n        throw new MessageError('\"tsc\" executable not found. Make sure \"typescript\" is installed as a project dependency.');\n    }\n    const tsConfigPath = getTsConfigPath(options, cwd);\n    if (!fs.existsSync(tsConfigPath)) {\n        throw new MessageError('\"tsconfig.json\" manifest not found.');\n    }\n    const tsConfig = readCompilerOptions(tsConfigPath);\n    const { target, module: mod } = tsConfig;\n    if (target !== tsc.ScriptTarget.ES2019) {\n        reporter.warning(`tsconfig.json [compilerOptions.target] should be \"es2019\", but found \"${target}\". You may encounter problems building.`);\n    }\n    if (mod !== tsc.ModuleKind.ESNext) {\n        reporter.warning(`tsconfig.json [compilerOptions.module] should be \"esnext\", but found \"${mod}\". You may encounter problems building.`);\n    }\n}\nexport async function beforeJob({ cwd }) {\n    const srcDirectory = path.join(cwd, 'src/');\n    if (!fs.existsSync(srcDirectory)) {\n        throw new MessageError('@pika/pack expects a standard package format, where package source must live in \"src/\".');\n    }\n    if (!fs.existsSync(path.join(cwd, 'src/index.ts')) && !fs.existsSync(path.join(cwd, 'src/index.tsx'))) {\n        throw new MessageError('@pika/pack expects a standard package format, where the package entrypoint must live at \"src/index\".');\n    }\n}\nexport async function afterJob({ out, reporter }) {\n    reporter.info('Linting with standard-pkg...');\n    const linter = new Lint(path.join(out, 'dist-src'));\n    await linter.init();\n    linter.summary();\n}\nexport function manifest(newManifest) {\n    newManifest.source = newManifest.source || 'dist-src/index.js';\n    newManifest.types = newManifest.types || 'dist-types/index.d.ts';\n    return newManifest;\n}\nexport async function build({ cwd, out, options, reporter }) {\n    const tscBin = path.join(cwd, 'node_modules/.bin/tsc');\n    await execa(tscBin, [\n        '--outDir',\n        path.join(out, 'dist-src/'),\n        '-d',\n        '--declarationDir',\n        path.join(out, 'dist-types/'),\n        '--project',\n        getTsConfigPath(options, cwd),\n        '--target',\n        'es2019',\n        '--module',\n        'esnext',\n        '--noEmit',\n        'false',\n    ], { cwd });\n    reporter.created(path.join(out, 'dist-src', 'index.js'), 'esnext');\n    reporter.created(path.join(out, 'dist-types', 'index.d.ts'), 'types');\n}\n"],"names":["formatTscParserErrors","errors","map","s","JSON","stringify","join","readCompilerOptions","configPath","loaded","tsc","file","read","readFile","Error","error","basePath","path","dirname","parsedConfig","config","length","formattedErrors","options","getTsConfigPath","cwd","resolve","tsconfig","beforeBuild","reporter","tscBin","fs","existsSync","MessageError","tsConfigPath","tsConfig","target","module","mod","ES2019","warning","ESNext","beforeJob","srcDirectory","afterJob","out","info","linter","Lint","init","summary","manifest","newManifest","source","types","build","execa","created"],"mappings":"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"}