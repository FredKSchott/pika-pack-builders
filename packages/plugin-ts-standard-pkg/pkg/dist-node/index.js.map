{"version":3,"file":"index.js","sources":["../dist-src/index.js"],"sourcesContent":["import copy from 'copy-concurrently';\r\nimport path from 'path';\r\nimport fs from 'fs';\r\nimport execa from 'execa';\r\nimport { MessageError } from '@pika/types';\r\nimport { Lint } from 'standard-pkg';\r\nimport * as tsc from 'typescript';\r\nfunction formatTscParserErrors(errors) {\r\n    return errors.map(s => JSON.stringify(s, null, 4)).join('\\n');\r\n}\r\nfunction readCompilerOptions(configPath) {\r\n    // First step: Let tsc pick up the config.\r\n    const loaded = tsc.readConfigFile(configPath, file => {\r\n        const read = tsc.sys.readFile(file);\r\n        // See https://github.com/Microsoft/TypeScript/blob/a757e8428410c2196886776785c16f8f0c2a62d9/src/compiler/sys.ts#L203 :\r\n        // `readFile` returns `undefined` in case the file does not exist!\r\n        if (!read) {\r\n            throw new Error(`ENOENT: no such file or directory, open '${configPath}'`);\r\n        }\r\n        return read;\r\n    });\r\n    // In case of an error, we cannot go further - the config is malformed.\r\n    if (loaded.error) {\r\n        throw new Error(JSON.stringify(loaded.error, null, 4));\r\n    }\r\n    // Second step: Parse the config, resolving all potential references.\r\n    const basePath = path.dirname(configPath); // equal to \"getDirectoryPath\" from ts, at least in our case.\r\n    const parsedConfig = tsc.parseJsonConfigFileContent(loaded.config, tsc.sys, basePath);\r\n    // In case the config is present, it already contains possibly merged entries from following the\r\n    // 'extends' entry, thus it is not required to follow it manually.\r\n    // This procedure does NOT throw, but generates a list of errors that can/should be evaluated.\r\n    if (parsedConfig.errors.length > 0) {\r\n        const formattedErrors = formatTscParserErrors(parsedConfig.errors);\r\n        throw new Error(`Some errors occurred while attempting to read from ${configPath}: ${formattedErrors}`);\r\n    }\r\n    return parsedConfig.options;\r\n}\r\nfunction getTsConfigPath(options, cwd) {\r\n    return path.resolve(cwd, options.tsconfig || 'tsconfig.json');\r\n}\r\nfunction getTscBin(cwd) {\r\n    try {\r\n        return require.resolve('typescript/bin/tsc', { paths: [cwd] });\r\n    }\r\n    catch (err) {\r\n        // ignore err\r\n        return null;\r\n    }\r\n}\r\nexport async function beforeBuild({ cwd, options, reporter }) {\r\n    if (!getTscBin(cwd)) {\r\n        throw new MessageError('\"tsc\" executable not found. Make sure \"typescript\" is installed as a project dependency.');\r\n    }\r\n    const tsConfigPath = getTsConfigPath(options, cwd);\r\n    if (!fs.existsSync(tsConfigPath)) {\r\n        throw new MessageError('\"tsconfig.json\" manifest not found.');\r\n    }\r\n    const tsConfig = readCompilerOptions(tsConfigPath);\r\n    const { target, module: mod } = tsConfig;\r\n    if (target !== tsc.ScriptTarget.ES2019) {\r\n        const _target = tsc.ScriptTarget[target] || '';\r\n        reporter.warning(`tsconfig.json [compilerOptions.target] should be \"es2019\", but found \"${_target ? _target.toLowerCase() : target}\". You may encounter problems building.`);\r\n    }\r\n    if (mod !== tsc.ModuleKind.ESNext) {\r\n        const _mod = tsc.ModuleKind[mod] || '';\r\n        reporter.warning(`tsconfig.json [compilerOptions.module] should be \"esnext\", but found \"${_mod ? _mod.toLowerCase() : mod}\". You may encounter problems building.`);\r\n    }\r\n}\r\nexport async function beforeJob({ cwd }) {\r\n    const srcDirectory = path.join(cwd, 'src/');\r\n    if (!fs.existsSync(srcDirectory)) {\r\n        throw new MessageError('@pika/pack expects a standard package format, where package source must live in \"src/\".');\r\n    }\r\n    if (!fs.existsSync(path.join(cwd, 'src/index.ts')) && !fs.existsSync(path.join(cwd, 'src/index.tsx'))) {\r\n        throw new MessageError('@pika/pack expects a standard package format, where the package entrypoint must live at \"src/index\".');\r\n    }\r\n}\r\nexport async function afterJob({ out, reporter }) {\r\n    reporter.info('Linting with standard-pkg...');\r\n    const linter = new Lint(path.join(out, 'dist-src'), { ignoreExtensions: true });\r\n    await linter.init();\r\n    linter.summary();\r\n}\r\nexport function manifest(newManifest) {\r\n    newManifest.source = newManifest.source || 'dist-src/index.js';\r\n    newManifest.types = newManifest.types || 'dist-types/index.d.ts';\r\n    return newManifest;\r\n}\r\nexport async function build({ cwd, out, options, reporter }) {\r\n    // Original source files are needed for declaration maps\r\n    const includedSrcDirectory = path.join(out, 'src/');\r\n    await copy(path.join(cwd, 'src/'), includedSrcDirectory);\r\n    const additionalArgs = options.args || [];\r\n    const result = execa(getTscBin(cwd), [\r\n        '--outDir',\r\n        path.join(out, 'dist-src/'),\r\n        '-d',\r\n        '--declarationDir',\r\n        path.join(out, 'dist-types/'),\r\n        '--declarationMap',\r\n        'true',\r\n        '--project',\r\n        getTsConfigPath(options, cwd),\r\n        '--target',\r\n        'es2019',\r\n        '--module',\r\n        'esnext',\r\n        '--noEmit',\r\n        'false',\r\n        '--sourceMap',\r\n        'false',\r\n        ...additionalArgs,\r\n    ], { cwd: includedSrcDirectory });\r\n    result.stderr.pipe(process.stderr);\r\n    result.stdout.pipe(process.stdout);\r\n    await result.catch(err => {\r\n        // Small formatting improvement.\r\n        console.log('');\r\n        throw err;\r\n    });\r\n    reporter.created(path.join(out, 'dist-src', 'index.js'), 'esnext');\r\n    reporter.created(path.join(out, 'dist-types', 'index.d.ts'), 'types');\r\n}\r\n"],"names":["formatTscParserErrors","errors","map","s","JSON","stringify","join","readCompilerOptions","configPath","loaded","tsc","file","read","readFile","Error","error","basePath","path","dirname","parsedConfig","config","length","formattedErrors","options","getTsConfigPath","cwd","resolve","tsconfig","getTscBin","require","paths","err","beforeBuild","reporter","MessageError","tsConfigPath","fs","existsSync","tsConfig","target","module","mod","ES2019","_target","warning","toLowerCase","ESNext","_mod","beforeJob","srcDirectory","afterJob","out","info","linter","Lint","ignoreExtensions","init","summary","manifest","newManifest","source","types","build","includedSrcDirectory","copy","additionalArgs","args","result","execa","stderr","pipe","process","stdout","catch","console","log","created"],"mappings":"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"}